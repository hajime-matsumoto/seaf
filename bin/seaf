#!/usr/bin/php -q
<?php
require_once dirname(__FILE__).'/../src/autoload.php';

define('SEAF_ROOT', realpath(dirname(__FILE__).'/../'));
define('SEAF_SYSTEM_TEMPLATE', SEAF_ROOT.'/bin/template');

$rt = Seaf::cli()->router();

$rt->map('init', function($req, $res, $cli) {

    // Utilを使う
    $util = Seaf::util();

    // 設定があればロードする
    $dir = getcwd();
    $setting = $dir.'/config/setting.yaml';

    // 初期値を設定
    if (file_exists($setting)) {
        $origin = $cli->yaml()->parse(file_get_contents($setting));
    }else{
        $origin = array();
        $origin['default'] = array();
        $origin['production'] = array('mode'=>'prodution');
        $origin['development'] = array('mode'=>'development');
    }

    // デフォルト
    $dft =& $origin['default'];

    $cli->out('プロジェクトを作成します。'."\n");

    $info['SeafRoot'] = SEAF_ROOT;

    $dft['project'] = $info['name'] = $name = $cli->in(
        'プロジェクト名',
        $util->arrayGet($dft,'project',basename($dir))
    );
    $dft['domain'] = $info['domain'] = $cli->in(
        "ドメイン",
        $util->arrayGet($dft, 'domain', basename($dir))
    );
    $dft['root']['path'] = $info['dir'] = $dir = $cli->in(
        "プロジェクトディレクトリ",
        $util->arrayGet($dft, 'root.path', getcwd())
    );
    $dft['public']['path'] = $info['public'] = $cli->in(
        "公開ディレクトリ",
        $util->arrayGet($dft, 'public.path', 'public')
    );
    $cli->mkdir($dft['root']['path'].'/'.$dft['public']['path']);

    $index_php = $dft['root']['path'].'/'.$dft['public']['path'].'/index.php';
    if (!file_exists($index_php)) {
        $index_php = $cli->in('indexを作成します。', $index_php);
        $cli->templateWrite(SEAF_SYSTEM_TEMPLATE.'/index.php', $info, $index_php);
    }

    $dft['logs']['path'] = $info['logs'] = $cli->in(
        "ログディレクトリ",
        $util->arrayGet($dft, 'logs.path', 'logs')
    );
    $cli->mkdir($dir.'/'.$dft['logs']['path']);

    $dft['view']['path'] = $info['view'] = $view = $cli->in(
        "VIEWディレクトリ",
        Seaf::util()->arrayGet($dft, 'view.path', 'view')
    );
    $cli->mkdir($dir.'/'.$view);

    $view_index = $dft['root']['path'].'/'.$view.'/index.php';
    if (!file_exists($view_index)) {
        $view_index = $cli->in('VIEW INDEXを作成します。', $view_index);
        $cli->templateWrite(SEAF_SYSTEM_TEMPLATE.'/view/index.php', $info, $view_index);
    }

    $dft['lib']['path'] = $info['lib'] = $libdir = $cli->in(
        "ライブラリディレクトリ",
        $util->arrayGet($dft, 'lib.path', 'lib')
    );
    $cli->mkdir($dir.'/'.$libdir.'/Seaf/Component');

    $dft['namespace'] = $info['namespace'] = $namespace = $cli->in(
        "ネームスペース",
        $util->arrayGet($dft, 'namespace', ucfirst($dft['project']))
    );

    $bootstrap = $cli->in('ブートストラップを作成します。', $dir.'/bootstrap.php');
    $cli->templateWrite(SEAF_SYSTEM_TEMPLATE.'/bootstrap.php', $info, $bootstrap);

    $cli->out('Bootstrapをテストします。');
    exec("php -f $bootstrap");

    $setting = $cli->in('設定ファイルを作成します。', $dir.'/config/setting.yaml');
    $cli->mkdir(dirname($setting));

    file_put_contents(
        $setting,
        $cli->yaml()->dump( $origin )
    );

    $nginx = $cli->in('Nginxの設定ファイルを作成します。', $dir.'/nginx.conf');
    $cli->templateWrite(SEAF_SYSTEM_TEMPLATE.'/nginx.conf', $info, $nginx);

    $apache = $cli->in('Apache2の設定ファイルを作成します。', $dir.'/apache2.conf');
    $cli->templateWrite(SEAF_SYSTEM_TEMPLATE.'/apache2.conf', $info, $apache);

    $cli->out('有効にするためには以下のコマンドを実行する必要があります。');
    $cli->out("");
    $cli->out("ln -s $apache /etc/apache2/sites-enabled/$name.conf");
    $cli->out("ln -s $nginx /etc/nginx/sites-enabled/$name.conf");

});

Seaf::cli()->run();

# vim: set ft=php :

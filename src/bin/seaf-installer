#!/usr/bin/php -q
<?php
require_once '../src/Seaf/bootstrap.php';

use Seaf\Console\Application;

define('PHP5_MODS_AVAILABLE',"/etc/php5/mods-available");
define('COMPOSER_JSON','./composer.json');

Seaf::init();
Seaf::logHandler('default',array(
    'type'=>'file',
    'file'=>'installer.log',
    'fileType'=>'w'
));

class Installer extends Application
{
    public function checkRoot ( )
    {
        if (getenv('USER') !== 'root') {
            $this->system()->halt('Root権限で実行してください');
        }
    }

    /**
     * @SeafDesc コンポーザのインストール
     * @SeafRoute composer
     */
    public function _composer()
    {
        $this->exec("curl -sS https://getcomposer.org/installer | php");
    }

    /**
     * @SeafDesc PEARのインストール
     * @SeafRoute pear
     */
    public function _pear()
    {
        $this->checkRoot();
        $this->exec("yes | apt-get install php-pear");
    }

    /**
     * @SeafDesc PHPUNITのインストール
     * @SeafRoute phpunit
     */
    public function _phpunit()
    {
        $this->checkRoot();
        $this->exec("pear config-set auto_discover 1");
        $this->exec("pear install pear.phpunit.de/PHPUnit");
        $this->exec("pear install pear.phpunit.de/PHPUnit_SkeletonGenerator");
    }

    /**
     * @SeafDesc Twigのインストール
     * @SeafRoute twig
     */
    public function _twig()
    {
        $this->checkRoot();
        $this->exec("pear install pear.twig-project.org/Twig");
    }

    /**
     * @SeafDesc Xdebugのインストール
     * @SeafRoute xdebug
     */
    public function _xdebug()
    {
        $this->checkRoot();
        $this->exec("pecl install xdebug");
        $list = $this->exec("find /usr/lib -name 'xdebug.so' | head -1", $buf = true);
        $file = trim($list);
        $fp = fopen(PHP5_MODS_AVAILABLE."/xdebug.ini", 'w');
        fwrite($fp, "; configuration for php Xdebug module\n");
        fwrite($fp, "; priority=20\n");
        fwrite($fp, "zend_extension=$file");
        fclose($fp);
        $this->out('Created: '.PHP5_MODS_AVAILABLE."/xdebug.ini");
        $this->exec('cat '.PHP5_MODS_AVAILABLE."/xdebug.ini");
        $this->exec('php5enmod xdebug');
    }

    /**
     * @SeafDesc Pyrusのインストール
     * @SeafRoute pyrus
     */
    public function _pyrus( )
    {
        $this->exec("wget https://packages.zendframework.com/pyrus.phar");
    }

    /**
     * @SeafDesc Yamlのインストール
     * @SeafRoute yaml
     */
    public function _yaml ( )
    {
        $this->checkRoot();
        $this->exec("pecl install yaml");
        $fp = fopen(PHP5_MODS_AVAILABLE."/yaml.ini", 'w');
        $list = $this->exec("find /usr/lib -name 'yaml.so' | head -1", $buf = true);
        $file = trim($list);
        fwrite($fp, "; configuration for php Yaml module\n");
        fwrite($fp, "; priority=20\n");
        fwrite($fp, "extension=$file");
        fclose($fp);
        $this->out('Created: '.PHP5_MODS_AVAILABLE."/yaml.ini");
        $this->exec('cat '.PHP5_MODS_AVAILABLE."/yaml.ini");
        $this->exec('php5enmod yaml');
    }

    /**
     * @SeafDesc php-consoleのインストール
     * @SeafRoute php-console
     */
    public function _phpConsole ( )
    {
        $origin = array();
        if (file_exists('composer.json')) {
            $origin = json_decode(file_get_contents(COMPOSER_JSON));
        }
        $origin['require']['php-console/php-console'] = '3.*';

        echo json_encode($origin);
    }
}

$installer = new Installer();
$installer->run();

?>
